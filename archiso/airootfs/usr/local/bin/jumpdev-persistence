#!/usr/bin/env bash
# JumpDev OS Persistence Manager
# Creates and manages the persistence.img file

set -e

PERSIST_FILE="persistence.img"
PERSIST_SIZE_GB=8
PERSIST_MOUNT="/persistence"
PERSIST_LABEL="JUMPDEV_PERSIST"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}→${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_error() { echo -e "${RED}✗${NC} $1"; }
log_warn() { echo -e "${YELLOW}!${NC} $1"; }

# Find the USB device we booted from
find_boot_device() {
    # Look for the device containing the ISO filesystem
    local boot_dev=""

    # Check /proc/cmdline for the boot device
    if grep -q "root=live" /proc/cmdline 2>/dev/null; then
        # Archiso live boot - find the USB device
        boot_dev=$(lsblk -no PKNAME $(findmnt -n -o SOURCE /) 2>/dev/null | head -1)
    fi

    # Fallback: look for removable devices
    if [[ -z "$boot_dev" ]]; then
        for dev in /sys/block/sd*; do
            if [[ -f "$dev/removable" ]] && [[ $(cat "$dev/removable") == "1" ]]; then
                boot_dev=$(basename "$dev")
                break
            fi
        done
    fi

    # Another fallback: check for USB devices
    if [[ -z "$boot_dev" ]]; then
        boot_dev=$(lsblk -d -o NAME,TRAN | grep usb | awk '{print $1}' | head -1)
    fi

    echo "$boot_dev"
}

# Find a partition with free space for persistence.img
find_persist_location() {
    local boot_dev="$1"

    # Look for a data partition on the USB (FAT32 or exFAT typically)
    for part in /dev/${boot_dev}*; do
        if [[ "$part" == "/dev/$boot_dev" ]]; then
            continue
        fi

        local fstype=$(lsblk -no FSTYPE "$part" 2>/dev/null)

        # Check if it's a writable filesystem (FAT32, exFAT, ext4, NTFS)
        if [[ "$fstype" =~ ^(vfat|exfat|ext4|ntfs)$ ]]; then
            # Check free space
            local mount_point=$(lsblk -no MOUNTPOINT "$part" 2>/dev/null)

            if [[ -z "$mount_point" ]]; then
                # Try to mount it temporarily
                mount_point="/tmp/jumpdev_persist_check"
                mkdir -p "$mount_point"
                if mount "$part" "$mount_point" 2>/dev/null; then
                    local free_gb=$(df -BG "$mount_point" | tail -1 | awk '{print $4}' | tr -d 'G')
                    umount "$mount_point" 2>/dev/null
                    rmdir "$mount_point" 2>/dev/null

                    if [[ $free_gb -ge $((PERSIST_SIZE_GB + 1)) ]]; then
                        echo "$part"
                        return 0
                    fi
                fi
            else
                local free_gb=$(df -BG "$mount_point" | tail -1 | awk '{print $4}' | tr -d 'G')
                if [[ $free_gb -ge $((PERSIST_SIZE_GB + 1)) ]]; then
                    echo "$part"
                    return 0
                fi
            fi
        fi
    done

    return 1
}

# Check if persistence is already set up
check_persistence() {
    if [[ -f "$PERSIST_MOUNT/.jumpdev_persist" ]]; then
        return 0
    fi
    return 1
}

# Create the persistence image
create_persistence() {
    local target_part="$1"
    local mount_point=""
    local needs_unmount=false

    log_info "Creating persistence on $target_part..."

    # Mount the partition if not already mounted
    mount_point=$(lsblk -no MOUNTPOINT "$target_part" 2>/dev/null)

    if [[ -z "$mount_point" ]]; then
        mount_point="/mnt/jumpdev_usb"
        mkdir -p "$mount_point"
        mount "$target_part" "$mount_point"
        needs_unmount=true
    fi

    local persist_path="$mount_point/$PERSIST_FILE"

    # Check if file already exists
    if [[ -f "$persist_path" ]]; then
        log_warn "Persistence file already exists at $persist_path"
        if $needs_unmount; then
            umount "$mount_point" 2>/dev/null
        fi
        return 1
    fi

    # Create the sparse file
    log_info "Creating ${PERSIST_SIZE_GB}GB persistence file (this may take a moment)..."
    dd if=/dev/zero of="$persist_path" bs=1M count=1 seek=$((PERSIST_SIZE_GB * 1024 - 1)) status=progress

    # Format as ext4
    log_info "Formatting as ext4..."
    mkfs.ext4 -F -L "$PERSIST_LABEL" "$persist_path"

    # Mount and initialize
    log_info "Initializing persistence..."
    mkdir -p "$PERSIST_MOUNT"
    mount -o loop "$persist_path" "$PERSIST_MOUNT"

    # Create marker file and directory structure
    touch "$PERSIST_MOUNT/.jumpdev_persist"
    mkdir -p "$PERSIST_MOUNT/home"
    mkdir -p "$PERSIST_MOUNT/etc"
    mkdir -p "$PERSIST_MOUNT/var"

    # Set permissions
    chmod 755 "$PERSIST_MOUNT"

    log_success "Persistence created successfully!"
    log_info "Location: $persist_path"
    log_info "Size: ${PERSIST_SIZE_GB}GB"

    if $needs_unmount; then
        # Don't unmount - we need it for the overlay
        log_info "Persistence mounted at $PERSIST_MOUNT"
    fi

    return 0
}

# Mount existing persistence
mount_persistence() {
    local boot_dev=$(find_boot_device)

    if [[ -z "$boot_dev" ]]; then
        log_error "Could not find boot device"
        return 1
    fi

    # Look for persistence.img on USB partitions
    for part in /dev/${boot_dev}*; do
        if [[ "$part" == "/dev/$boot_dev" ]]; then
            continue
        fi

        local mount_point=$(lsblk -no MOUNTPOINT "$part" 2>/dev/null)
        local temp_mount=false

        if [[ -z "$mount_point" ]]; then
            mount_point="/tmp/jumpdev_persist_search"
            mkdir -p "$mount_point"
            if ! mount -o ro "$part" "$mount_point" 2>/dev/null; then
                continue
            fi
            temp_mount=true
        fi

        if [[ -f "$mount_point/$PERSIST_FILE" ]]; then
            log_info "Found persistence at $mount_point/$PERSIST_FILE"

            if $temp_mount; then
                umount "$mount_point"
                mount "$part" "$mount_point"
            fi

            mkdir -p "$PERSIST_MOUNT"
            mount -o loop "$mount_point/$PERSIST_FILE" "$PERSIST_MOUNT"
            log_success "Persistence mounted at $PERSIST_MOUNT"
            return 0
        fi

        if $temp_mount; then
            umount "$mount_point" 2>/dev/null
            rmdir "$mount_point" 2>/dev/null
        fi
    done

    log_warn "No persistence found"
    return 1
}

# Setup overlay for home directory
setup_overlay() {
    if [[ ! -d "$PERSIST_MOUNT" ]] || [[ ! -f "$PERSIST_MOUNT/.jumpdev_persist" ]]; then
        log_error "Persistence not mounted"
        return 1
    fi

    log_info "Setting up overlay filesystem..."

    # Create overlay directories
    mkdir -p "$PERSIST_MOUNT/home/upper"
    mkdir -p "$PERSIST_MOUNT/home/work"

    # Mount overlay on /home
    mount -t overlay overlay \
        -o lowerdir=/home,upperdir=$PERSIST_MOUNT/home/upper,workdir=$PERSIST_MOUNT/home/work \
        /home

    log_success "Home directory overlay active"
    return 0
}

# Main commands
case "${1:-help}" in
    check)
        if check_persistence; then
            echo "Persistence is active"
            exit 0
        else
            echo "Persistence is not active"
            exit 1
        fi
        ;;
    create)
        boot_dev=$(find_boot_device)
        if [[ -z "$boot_dev" ]]; then
            log_error "Could not find boot device"
            exit 1
        fi
        log_info "Boot device: /dev/$boot_dev"

        target_part=$(find_persist_location "$boot_dev")
        if [[ -z "$target_part" ]]; then
            log_error "No suitable partition found with ${PERSIST_SIZE_GB}GB+ free space"
            exit 1
        fi
        log_info "Target partition: $target_part"

        create_persistence "$target_part"
        ;;
    mount)
        mount_persistence
        ;;
    overlay)
        setup_overlay
        ;;
    status)
        echo "Persistence Status"
        echo "=================="
        if mountpoint -q "$PERSIST_MOUNT" 2>/dev/null; then
            log_success "Persistence mounted at $PERSIST_MOUNT"
            df -h "$PERSIST_MOUNT"
        else
            log_warn "Persistence not mounted"
        fi
        ;;
    help|*)
        echo "JumpDev Persistence Manager"
        echo ""
        echo "Usage: jumpdev-persistence <command>"
        echo ""
        echo "Commands:"
        echo "  check    Check if persistence is active"
        echo "  create   Create persistence.img on USB"
        echo "  mount    Mount existing persistence"
        echo "  overlay  Setup overlay filesystem"
        echo "  status   Show persistence status"
        echo "  help     Show this help"
        ;;
esac
