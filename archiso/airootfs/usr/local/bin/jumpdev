#!/usr/bin/env bash
# JumpDev OS Helper Command
# Usage: jumpdev <command> [args]

set -e

VERSION="0.1.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

print_header() {
    echo -e "${PURPLE}JumpDev OS${NC} v${VERSION}"
    echo ""
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_info() {
    echo -e "${BLUE}→${NC} $1"
}

print_warn() {
    echo -e "${YELLOW}!${NC} $1"
}

# Commands

cmd_help() {
    print_header
    echo "Usage: jumpdev <command> [options]"
    echo ""
    echo -e "${YELLOW}Setup & Configuration${NC}"
    echo "  setup              Run first-time setup wizard"
    echo "  set-api-key        Configure API keys (Anthropic, OpenAI)"
    echo ""
    echo -e "${YELLOW}AI Tools${NC}"
    echo "  install-aider      Install Aider (requires persistence)"
    echo "  install-ollama     Reinstall/update Ollama"
    echo "  install-claude     Reinstall/update Claude Code"
    echo ""
    echo -e "${YELLOW}System${NC}"
    echo "  update             Update system and dev tools"
    echo "  doctor             Check system health"
    echo "  cleanup            Clean package cache to save space"
    echo ""
    echo -e "${YELLOW}Info${NC}"
    echo "  help               Show this help message"
    echo "  version            Show version"
    echo ""
    echo "Examples:"
    echo "  jumpdev setup"
    echo "  jumpdev set-api-key anthropic"
    echo "  jumpdev install-aider"
}

cmd_version() {
    echo "JumpDev OS v${VERSION}"
}

cmd_setup() {
    print_header
    echo "Welcome to JumpDev OS!"
    echo ""
    print_info "This wizard will help you set up your development environment."
    echo ""

    # Check for persistence
    if ! mountpoint -q /persistence 2>/dev/null; then
        print_warn "Persistence not detected. Files won't be saved between reboots."
        print_info "To enable persistence, reflash with a persistence partition."
        echo ""
    else
        print_success "Persistence detected. Your files will be saved."
        echo ""
    fi

    # Offer to set up API keys
    read -p "Would you like to set up API keys now? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        cmd_set_api_key
    fi

    echo ""
    print_success "Setup complete! You're ready to code."
    echo ""
    echo "Quick start:"
    echo "  • Open terminal: Super + Return"
    echo "  • App launcher: Super + D"
    echo "  • Start coding: claude"
    echo ""
}

cmd_set_api_key() {
    print_header
    echo "API Key Configuration"
    echo ""

    PS3="Select provider: "
    select provider in "Anthropic (Claude)" "OpenAI" "Cancel"; do
        case $provider in
            "Anthropic (Claude)")
                echo ""
                read -p "Enter your Anthropic API key: " -s api_key
                echo ""
                if [[ -n "$api_key" ]]; then
                    mkdir -p ~/.config/claude
                    echo "ANTHROPIC_API_KEY=$api_key" >> ~/.bashrc
                    echo "export ANTHROPIC_API_KEY=$api_key" >> ~/.zshrc
                    print_success "Anthropic API key saved"
                    print_info "Restart your shell or run: source ~/.zshrc"
                fi
                break
                ;;
            "OpenAI")
                echo ""
                read -p "Enter your OpenAI API key: " -s api_key
                echo ""
                if [[ -n "$api_key" ]]; then
                    echo "OPENAI_API_KEY=$api_key" >> ~/.bashrc
                    echo "export OPENAI_API_KEY=$api_key" >> ~/.zshrc
                    print_success "OpenAI API key saved"
                    print_info "Restart your shell or run: source ~/.zshrc"
                fi
                break
                ;;
            "Cancel")
                break
                ;;
            *)
                echo "Invalid option"
                ;;
        esac
    done
}

cmd_install_aider() {
    print_header
    print_info "Installing Aider..."

    # Check for persistence/space
    available_space=$(df -BM /home | tail -1 | awk '{print $4}' | tr -d 'M')
    if [[ $available_space -lt 500 ]]; then
        print_error "Not enough space. Aider requires ~500MB."
        print_info "Enable persistence first, then try again."
        exit 1
    fi

    # Install using pipx
    if command -v pipx &> /dev/null; then
        pipx install aider-chat
        print_success "Aider installed successfully"
        print_info "Run 'aider' to start"
    else
        print_error "pipx not found"
        exit 1
    fi
}

cmd_install_ollama() {
    print_header
    print_info "Installing/updating Ollama..."
    curl -fsSL https://ollama.com/install.sh | sh
    print_success "Ollama installed"
    print_info "Run 'ollama run llama3' to get started"
}

cmd_install_claude() {
    print_header
    print_info "Installing/updating Claude Code..."
    npm install -g @anthropic-ai/claude-code
    print_success "Claude Code installed"
    print_info "Run 'claude' to start"
}

cmd_update() {
    print_header
    print_info "Updating system..."

    # Update pacman packages
    sudo pacman -Syu --noconfirm

    # Update npm global packages
    print_info "Updating npm packages..."
    npm update -g

    # Update pipx packages
    if command -v pipx &> /dev/null; then
        print_info "Updating pipx packages..."
        pipx upgrade-all 2>/dev/null || true
    fi

    print_success "System updated"
}

cmd_doctor() {
    print_header
    echo "System Health Check"
    echo ""

    # Check key commands
    echo "AI Tools:"
    command -v claude &>/dev/null && print_success "Claude Code" || print_error "Claude Code not found"
    command -v ollama &>/dev/null && print_success "Ollama" || print_error "Ollama not found"
    command -v aider &>/dev/null && print_success "Aider" || print_warn "Aider not installed (run: jumpdev install-aider)"
    echo ""

    echo "Development:"
    command -v git &>/dev/null && print_success "Git $(git --version | cut -d' ' -f3)" || print_error "Git not found"
    command -v node &>/dev/null && print_success "Node $(node --version)" || print_error "Node not found"
    command -v python &>/dev/null && print_success "Python $(python --version | cut -d' ' -f2)" || print_error "Python not found"
    command -v docker &>/dev/null && print_success "Docker $(docker --version | cut -d' ' -f3 | tr -d ',')" || print_error "Docker not found"
    echo ""

    echo "System:"
    # Disk space
    root_space=$(df -h / | tail -1 | awk '{print $4}')
    home_space=$(df -h /home | tail -1 | awk '{print $4}')
    print_info "Root space: $root_space"
    print_info "Home space: $home_space"

    # Memory
    mem_available=$(free -h | grep Mem | awk '{print $7}')
    print_info "Memory available: $mem_available"

    # Persistence
    if mountpoint -q /persistence 2>/dev/null; then
        print_success "Persistence enabled"
    else
        print_warn "Persistence not enabled"
    fi
    echo ""
}

cmd_cleanup() {
    print_header
    print_info "Cleaning up..."

    # Clean pacman cache
    sudo pacman -Sc --noconfirm

    # Clean npm cache
    npm cache clean --force 2>/dev/null || true

    # Clean pipx cache
    rm -rf ~/.cache/pipx 2>/dev/null || true

    print_success "Cleanup complete"
}

# Main

case "${1:-help}" in
    help|--help|-h)
        cmd_help
        ;;
    version|--version|-v)
        cmd_version
        ;;
    setup)
        cmd_setup
        ;;
    set-api-key)
        cmd_set_api_key
        ;;
    install-aider)
        cmd_install_aider
        ;;
    install-ollama)
        cmd_install_ollama
        ;;
    install-claude)
        cmd_install_claude
        ;;
    update)
        cmd_update
        ;;
    doctor)
        cmd_doctor
        ;;
    cleanup)
        cmd_cleanup
        ;;
    *)
        print_error "Unknown command: $1"
        echo "Run 'jumpdev help' for usage"
        exit 1
        ;;
esac
